---
title: "Data Exploration and Modelling"
format: html
editor: visual
---

## 1. Libraries

### 1.1 Install Libraries

```{r}
install.packages(c('tidyverse', 'skimr', 'corrplot', 'janitor', 'tidymodels',
                   'randomForest', 'caret', 'rpart', 'rpart.plot'))
```

### 1.2 Load Libraries

```{r}
library(tidyverse)          
library(skimr)    
library(corrplot)
library(janitor)
library(tidymodels)
library(randomForest)
library(caret)
library(rpart)      
library(rpart.plot)

```

## 2. Load Data

```{r}
df <- read_csv('data/synthetic_customer_behavior_and_churn.csv')
```

### 2.1 Preview Data

```{r}
head(df)
```

## 3. Data Exploration

### 3.1. Data Overview

#### Column Names

```{r}
colnames(df)
```

#### Distinct Customers

```{r}
n_distinct(df$customer_id)
```

#### Data Structure

```{r}
glimpse(df)
```

#### Missing Values

```{r}
skim(df)
```

### 3.2 Minimal EDA

#### Target Variable: Churn

```{r}
df %>% 
  count(churn)
```

#### Correlation

```{r}
numeric_df <- df %>% 
  select(where(is.numeric))

cor_matrix <- cor(numeric_df)

corrplot(cor_matrix,
         method = 'color',
         type = 'upper',
         tl.col = 'black',
         tl.cex = 0.5)
```

#### Simple Churn Comparrison

```{r}
df %>% 
  group_by(churn) %>% 
  summarise(across(where(is.numeric), mean))
```

## 4. Data Manipulation

### 4.1 Clean Data Types

```{r}
df <- df %>%
  mutate(
    churn = factor(churn),
    gender = factor(gender),
    region = factor(region),
    income_level = factor(income_level),
    subscription_type = factor(subscription_type),
    payment_method = factor(payment_method),
    contract_type = factor(contract_type),
    promotional_response = factor(promotional_response),
    discount_used = factor(discount_used),
    usage_frequency = factor(usage_frequency)
  )

```

### 4.2 Drop Redundant Variables

-   `customer_id` adds no value to the model so can be removed.

-   `total_charges` shows a strong correlation with `montly_charges`. To prevent multicolinarity, `total_charges` is removed before modelling.

-   `signup_data` adds no significant value to the model as `tenure_months` is more valuable.

```{r}
df <- df %>% 
  select(-customer_id, -total_charges, -signup_date)
```

## 4.3 Split Data

Split the data into a training set and a test set

```{r}
set.seed(1998)

churn_split <- initial_split(df, prop = 0.8, strata = churn)
churn_train <- training(churn_split)
churn_test <- testing(churn_split)
```

Check if proportions in training and testing data are similar to complete dataset

```{r}
count(churn_train, churn) %>% 
  mutate(prop = round(n/sum(n),2))
```

```{r}
count(churn_test, churn) %>% 
  mutate(prop = round(n/sum(n),2))
```

Both sets show the same proportion of churn and not churns. The split should fit the training and testing process.

## 5. Modelling

### 5.1 Logistic Regression

```{r}
model1 <- glm(churn ~ .,
              data   = churn_train,
              family = binomial(link = 'logit'))

pred <- predict(model1 , newdata = churn_test, type = 'response')

# Convert probs to binary
pred <- as.factor(ifelse(pred > 0.5, 1, 0))

# Evaluation Metrics
result    <- confusionMatrix(data = pred, churn_test$churn)
precision <- result$byClass['Pos Pred Value']
recall    <- result$byClass['Sensitivity']
F1        <- result$byClass['F1']

```

```{r}
result
```

### 5.2 Decision Tree

```{r}
tree_model <- rpart(churn ~ .,
                    data = churn_train,
                    method = "class",
                    control = rpart.control(xval = 10))

# Plot
rpart.plot(tree_model)
```

```{r}
pred      <- predict(tree_model, newdata = churn_test, type = "class")
result    <- confusionMatrix(data = pred, churn_test$churn)
precision <- result$byClass['Pos Pred Value']
recall    <- result$byClass['Sensitivity']
F1        <- result$byClass['F1']
```

```{r}
result
```
